<!-- app/frontend/templates/index.html -->
{% extends "base.html" %}
{% block title %}–ó–∞—è–≤–∫–∏ –Ω–∞ —Ä–µ–º–æ–Ω—Ç{% endblock %}
{% block header %}–ó–∞—è–≤–∫–∏ –Ω–∞ —Ä–µ–º–æ–Ω—Ç{% endblock %}
{% block content %}

<table>
  <thead>
    <tr>
      <th>ID</th>
      <th>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</th>
      <th>–¢–∏–ø –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è</th>
      <th>–°—Ç–∞—Ç—É—Å</th>
      <th>–ú–∞—Å—Ç–µ—Ä</th>
      {% if user_role != "client" %}
        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
      {% endif %}
    </tr>
  </thead>
  <tbody>
    {% for req in requests %}
    <tr>
      <td>{{ req.requestID }}</td>
      <td>{{ req.startDate }}</td>
      <td>{{ req.applianceType }}</td>
      <td>{{ req.requestStatus }}</td>
      <td>
        {% if req.masterID %}
          {{ get_user_fio(req.masterID) }}
        {% else %}
          <em>–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω</em>
        {% endif %}
      </td>
      <td>
        {% if user_role == "specialist" and req.masterID == current_user_id %}
          <a href="/comment/{{ req.requestID }}" class="button">üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</a>
          <a href="/help/{{ req.requestID }}" class="button" style="background: #ff9800;">üÜò –û–±—Ä–∞—Ç–∏—Ç—å—Å—è –∑–∞ –ø–æ–º–æ—â—å—é</a>
        {% elif user_role == "operator" %}
          <a href="/edit/{{ req.requestID }}" class="button">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
        {% elif user_role in ["manager", "admin"] %}
          <a href="/assign/{{ req.requestID }}" class="button">–ù–∞–∑–Ω–∞—á–∏—Ç—å</a>
          <a href="/edit/{{ req.requestID }}" class="button">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
          <a href="/extend/{{ req.requestID }}" class="button" style="background: #2196F3;">üìÖ –ü—Ä–æ–¥–ª–∏—Ç—å —Å—Ä–æ–∫</a>
        {% endif %}
      </td>
    </tr>
    <!-- –û–∂–∏–¥–∞–µ–º–∞—è –¥–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è (–µ—Å–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞) -->
    {% if req.expectedCompletionDate %}
      <tr>
        <td colspan="6" style="padding-top: 0; border-top: none;">
          <div style="background: #e3f2fd; padding: 8px; border-radius: 4px; margin-top: 4px; font-size: 13px;">
            <strong>üìÖ –û–∂–∏–¥–∞–µ–º–∞—è –¥–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è:</strong> {{ req.expectedCompletionDate }}
          </div>
        </td>
      </tr>
    {% endif %}
    <!-- –û–±—Ä–∞—â–µ–Ω–∏—è –∑–∞ –ø–æ–º–æ—â—å—é -->
    {% if req.help_comments %}
      <tr>
        <td colspan="6" style="padding-top: 0; border-top: none;">
          <div style="background: #fff3cd; padding: 12px; border-radius: 4px; margin-top: 8px; font-size: 14px; border-left: 4px solid #ff9800;">
            <strong>üÜò –û–±—Ä–∞—â–µ–Ω–∏—è –∑–∞ –ø–æ–º–æ—â—å—é:</strong>
            <ul style="margin: 8px 0 0; padding-left: 20px;">
              {% for comment in req.help_comments %}
                <li>
                  <em>{{ get_user_fio(comment.masterID) }}</em>: 
                  "{{ comment.message }}"
                  {% if comment.created_at %}
                    <small style="color: #6c757d;">({{ comment.created_at }})</small>
                  {% endif %}
                </li>
              {% endfor %}
            </ul>
          </div>
        </td>
      </tr>
    {% endif %}
    <!-- –û–±—ã—á–Ω—ã–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ -->
    {% if req.regular_comments %}
      <tr>
        <td colspan="6" style="padding-top: 0; border-top: none;">
          <div style="background: #f8f9fa; padding: 12px; border-radius: 4px; margin-top: 8px; font-size: 14px;">
            <strong>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏:</strong>
            <ul style="margin: 8px 0 0; padding-left: 20px;">
              {% for comment in req.regular_comments %}
                <li>
                  <em>{{ get_user_fio(comment.masterID) }}</em>: 
                  "{{ comment.message }}"
                  {% if comment.created_at %}
                    <small style="color: #6c757d;">({{ comment.created_at }})</small>
                  {% endif %}
                </li>
              {% endfor %}
            </ul>
          </div>
        </td>
      </tr>
    {% endif %}
    <!-- QR-–∫–æ–¥ –¥–ª—è –∑–∞–∫–∞–∑—á–∏–∫–∞ –ø–æ–¥ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–º–∏ –∑–∞—è–≤–∫–∞–º–∏ -->
    {% if user_role == "client" and req.requestStatus == "–ì–æ—Ç–æ–≤–∞ –∫ –≤—ã–¥–∞—á–µ" %}
      <tr>
        <td colspan="6" style="padding: 15px 0 0; border: none;">
          <div style="background: #e9f7ef; padding: 12px; border-radius: 6px; display: inline-block; text-align: center;">
            <strong>‚úÖ –ó–∞—è–≤–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞! –û—Ü–µ–Ω–∏—Ç–µ –∫–∞—á–µ—Å—Ç–≤–æ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è:</strong><br>
            <img src="https://api.qrserver.com/v1/create-qr-code/?size=120x120&data=https%3A%2F%2Fdocs.google.com%2Fforms%2Fd%2Fe%2F1FAIpQLSdhZcExx6LSIXxk0ub55mSu-WIh23WYdGG9HY5EZhLDo7P8eA%2Fviewform" 
                 alt="QR-–∫–æ–¥ –¥–ª—è –æ—Ç–∑—ã–≤–∞"
                 style="margin-top: 8px; vertical-align: middle;">
          </div>
        </td>
      </tr>
    {% endif %}
    {% endfor %}
  </tbody>
</table>
{% endblock %}